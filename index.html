<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>åƒé£¯é¸æ“‡å™¨</title>
<style>
  :root{
    --bg:#fafafa;
    --card:#ffffff;
    --ink:#111;
    --muted:#666;
    --accent:#2e7df6;
    --chip:#f0f3f9;
    --border:#e9e9ee;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";}
  header{position:sticky;top:0;background:linear-gradient(180deg,#fff,rgba(255,255,255,0.92));backdrop-filter:saturate(180%) blur(8px);border-bottom:1px solid var(--border);z-index:10}
  .wrap{max-width:900px;margin:0 auto;padding:20px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  h1{font-size:22px;margin:0;padding:14px 20px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 1px 0 rgba(0,0,0,.04)}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:15px}
  button{appearance:none;border:none;border-radius:12px;padding:10px 14px;font-size:15px;cursor:pointer;background:var(--accent);color:#fff}
  button.alt{background:#f1f3f5;color:#111;border:1px solid var(--border)}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--border);font-size:13px;margin:4px 6px 0 0;cursor:pointer;user-select:none}
  .chip input{display:none}
  .chip.active{outline:2px solid var(--accent);background:#eaf1ff}
  .result{display:grid;grid-template-columns:1fr;gap:12px}
  .result .item{display:flex;justify-content:space-between;align-items:flex-start;padding:14px;border:1px solid var(--border);border-radius:12px;background:#fff}
  .result .item h3{margin:0 0 6px 0}
  .muted{color:var(--muted)}
  .small{font-size:12px}
  .btns{display:flex;gap:8px;flex-wrap:wrap}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  .right{margin-left:auto}
  .divider{height:1px;background:var(--border);margin:10px 0}
  .footer{font-size:12px;color:var(--muted);text-align:center;padding:18px 0}
  .pill{display:inline-block;background:#eef2ff;border:1px solid var(--border);color:#223; padding:4px 8px;border-radius:999px;font-size:12px;margin-right:6px}
  .danger{background:#e53935}
  .ghost{background:transparent;color:#111;border:1px solid var(--border)}
  .spin-wheel{width:100%;height:280px;border-radius:14px;border:1px dashed var(--border);display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;background:#fff}
  .slice{position:absolute;left:50%;top:50%;transform-origin:0 0}
  .marker{position:absolute;top:8px;left:50%;transform:translate(-50%);font-size:24px}

  /* Modal (é€šç”¨) */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.28);backdrop-filter:blur(3px);z-index:50;padding:18px}
  .modal.show{display:flex}
  .modal .box{width:min(640px,100%);background:#fff;border-radius:14px;border:1px solid var(--border);box-shadow:0 10px 30px rgba(0,0,0,.15);padding:14px}
  .modal .box h3{margin:0 0 8px}
  .modal .box .result{max-height:60vh;overflow:auto}
  .modal .head{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
</style>
</head>
<body>
  <header><h1>ğŸ½ï¸ åƒé£¯é¸æ“‡å™¨</h1></header>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <div style="flex:1 1 260px">
          <label>é—œéµå­—</label>
          <input id="q" placeholder="è¼¸å…¥åº—åã€é—œéµè©â€¦">
        </div>
        <div style="width:150px">
          <label>åƒ¹ä½</label>
          <select id="price">
            <option value="">ä¸é™</option>
            <option value="$">$</option>
            <option value="$$">$$</option>
            <option value="$$$">$$$</option>
          </select>
        </div>
        <div style="width:160px">
          <label>æ™‚æ®µ</label>
          <select id="time">
            <option value="">ä¸é™</option>
            <option>æ—©é¤</option>
            <option>æ—©åˆé¤</option>
            <option>åˆé¤</option>
            <option>åˆæ™šé¤</option>
            <option>æ™šé¤</option>
            <option>å®µå¤œ</option>
          </select>
        </div>
        <div style="width:160px">
          <label>è·é›¢(æ­¥è¡Œåˆ†é˜)</label>
          <select id="walk">
            <option value="">ä¸é™</option>
            <option value="5">â‰¤5</option>
            <option value="10">â‰¤10</option>
            <option value="15">â‰¤15</option>
            <option value="20">â‰¤20</option>
          </select>
        </div>
      </div>
      <div style="margin-top:10px">
        <label>æ¨™ç±¤ï¼ˆå¤šé¸ï¼‰</label>
        <div id="tags" class="muted small">ç›®å‰æ²’æœ‰æ¨™ç±¤ï¼Œæ–°å¢åº—å®¶æ™‚å¯ç”¨é€—è™Ÿè¼¸å…¥ï¼šä¾‹å¦‚ã€Œä¾¿ç•¶,æ¹¯éºµã€</div>
      </div>
      <div class="btns" style="margin-top:12px">
        <button id="pick1">æŠ½ä¸€å€‹</button>
        <button class="alt" id="pick3">æŠ½ä¸‰å€‹çµ¦æˆ‘é¸</button>
        <button class="alt" id="spin">è½‰ç›¤æ¨¡å¼</button>
        <span class="right small muted">æç¤ºï¼šå¯å…ˆæ–°å¢æ¸…å–®æˆ–åŒ¯å…¥</span>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h3 style="margin:0 0 8px">ğŸ“‹ æ¸…å–®ï¼ˆä¸Šæ–¹è¼¸å…¥ï¼Œæ–°å¢å¾Œå‡ºç¾åœ¨ä¸‹æ–¹ï¼‰</h3>

        <!-- Form first -->
        <div class="row">
          <div style="flex:1 1 200px">
            <label>åº—å</label>
            <input id="name" placeholder="ä¾‹å¦‚ï¼šé˜¿æ˜æ»·è‚‰é£¯">
          </div>
          <div style="width:120px">
            <label>åƒ¹ä½</label>
            <select id="nprice">
              <option value="$">$</option>
              <option value="$$">$$</option>
              <option value="$$$">$$$</option>
            </select>
          </div>
          <div style="width:140px">
            <label>æ­¥è¡Œ(åˆ†é˜)</label>
            <input id="nwalk" type="number" min="0" placeholder="å¦‚ 8">
          </div>
          <div style="flex:1 1 180px">
            <label>æ¨™ç±¤ (é€—è™Ÿåˆ†éš”)</label>
            <input id="ntags" placeholder="å¦‚ï¼šä¾¿ç•¶,æ¹¯éºµ,å…§ç”¨">
          </div>
          <div style="flex:1 1 200px">
            <label>æ™‚æ®µ</label>
            <select id="ntime">
              <option>æ—©é¤</option><option>æ—©åˆé¤</option><option selected>åˆé¤</option><option>åˆæ™šé¤</option><option>æ™šé¤</option><option>å®µå¤œ</option>
            </select>
          </div>
          <div style="flex:1 1 240px">
            <label>å‚™è¨»</label>
            <input id="nnote" placeholder="å¦‚ï¼šæ‹›ç‰Œé›è…¿é£¯">
          </div>
        </div>
        <div class="btns" style="margin-top:10px">
          <button id="add">æ–°å¢</button>
          <!-- CSV å°ˆç”¨ï¼š -->
          <button class="ghost" id="exportCsv">åŒ¯å‡º CSV</button>
          <label class="chip" for="importCsv">åŒ¯å…¥ CSV<input id="importCsv" type="file" accept=".csv,text/csv"></label>
          <button class="ghost" id="pasteOpen">å¾è²¼ä¸ŠåŒ¯å…¥</button>
          <button class="danger" id="reset">æ¸…ç©ºå…¨éƒ¨</button>
        </div>

        <div class="divider"></div>
        <div id="list" class="result"></div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px">ğŸ¯ çµæœ</h3>
        <div id="result" class="result"></div>
        <div id="wheelBox" style="display:none">
          <div class="spin-wheel" id="wheel">
            <div class="marker">â–¼</div>
          </div>
          <div class="btns" style="margin-top:10px">
            <button id="spinGo">é–‹å§‹è½‰</button>
            <button class="alt" id="spinExit">è¿”å›åˆ—è¡¨</button>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">è³‡æ–™åªå­˜æ–¼æ­¤è£ç½®ï¼ˆLocalStorageï¼‰ã€‚å¯åŒ¯å‡º/åŒ¯å…¥èˆ‡æœ‹å‹å…±äº«æ¸…å–®ã€‚</div>
  </div>

  <!-- Modalï¼šæŠ½é¸çµæœ -->
  <div class="modal" id="modal">
    <div class="box">
      <div class="head">
        <h3 id="modalTitle">æŠ½é¸çµæœ</h3>
        <div class="btns">
          <button class="ghost" id="modalClose">é—œé–‰</button>
        </div>
      </div>
      <div id="modalContent" class="result"></div>
    </div>
  </div>

  <!-- Modalï¼šå¾è²¼ä¸ŠåŒ¯å…¥ -->
  <div class="modal" id="pasteModal">
    <div class="box">
      <div class="head">
        <h3>å¾è²¼ä¸ŠåŒ¯å…¥</h3>
        <div class="btns"><button class="ghost" id="pasteClose">é—œé–‰</button></div>
      </div>
      <div class="small muted" style="margin-bottom:8px">
        åœ¨ Excel/Google è©¦ç®—è¡¨é¸å–å…­æ¬„ï¼ˆname, price, walk, tags, time, noteï¼‰å¾Œè¤‡è£½ï¼Œè²¼åˆ°ä¸‹é¢å†æŒ‰ã€ŒåŒ¯å…¥ã€ã€‚
      </div>
      <textarea id="pasteArea" style="width:100%;height:180px;border:1px solid var(--border);border-radius:10px;padding:10px"></textarea>
      <div class="btns" style="margin-top:10px">
        <button id="pasteImport">åŒ¯å…¥</button>
      </div>
    </div>
  </div>

<script>
// DOM helper
const $ = (sel) => document.querySelector(sel);

const KEY='mealPicker.v1';
let state = load();
if(!state.items){ state.items = []; save(); }

const els = {
  q:$('#q'), price:$('#price'), time:$('#time'), walk:$('#walk'), tags:$('#tags'),
  list:$('#list'), result:$('#result'),
  add:$('#add'), name:$('#name'), nprice:$('#nprice'), nwalk:$('#nwalk'), ntags:$('#ntags'), ntime:$('#ntime'), nnote:$('#nnote'),
  exportCsv:$('#exportCsv'), importCsv:$('#importCsv'), reset:$('#reset'),
  pick1:$('#pick1'), pick3:$('#pick3'), spin:$('#spin'),
  wheelBox:$('#wheelBox'), wheel:$('#wheel'), spinGo:$('#spinGo'), spinExit:$('#spinExit'),
  modal:$('#modal'), modalTitle:$('#modalTitle'), modalContent:$('#modalContent'), modalClose:$('#modalClose')
};

// ---- å‹•æ…‹æ¨™ç±¤ï¼ˆç„¡é è¨­ï¼‰ï¼šå®Œå…¨ä¾†è‡ªç›®å‰æ¸…å–® ----
function allTags(){
  const set = new Set();
  (state.items||[]).forEach(it => (it.tags||[]).forEach(t => t && set.add(String(t))));
  return [...set].sort((a,b)=>a.localeCompare(b,'zh-Hant'));
}

function renderTagChips(){
  const tags = allTags();
  const checked = new Set([...els.tags.querySelectorAll('input:checked')].map(x=>x.value)); // ä¿ç•™åŸå‹¾é¸
  els.tags.innerHTML = tags.length ? '' : '<span class="muted small">ç›®å‰æ²’æœ‰æ¨™ç±¤ï¼Œæ–°å¢åº—å®¶æ™‚å¯ç”¨é€—è™Ÿè¼¸å…¥ï¼šä¾‹å¦‚ã€Œä¾¿ç•¶,æ¹¯éºµã€</span>';
  tags.forEach(t=>{
    const d=document.createElement('label');
    d.className='chip';
    const input=document.createElement('input');
    input.type='checkbox';
    input.value=t;
    const span=document.createElement('span');
    span.textContent=t;
    d.appendChild(input);
    d.appendChild(span);

    input.checked = checked.has(t);
    d.classList.toggle('active', input.checked);

    d.addEventListener('click', (e)=>{
      if(e.target !== input){ input.checked = !input.checked; }
      d.classList.toggle('active', input.checked);
      e.preventDefault();
      e.stopPropagation();
      renderList();
    });
    input.addEventListener('change', ()=>{
      d.classList.toggle('active', input.checked);
      renderList();
    });

    els.tags.appendChild(d);
  });
}
renderTagChips();

// Event bindings
[els.q,els.price,els.time,els.walk].forEach(x=>x.addEventListener('input',renderList));

els.add.onclick=()=>{
  const name=els.name.value.trim();
  if(!name){ alert('è«‹è¼¸å…¥åº—å'); return; }
  const item={
    id:uid(),
    name,
    price:els.nprice.value,
    walk: parseInt(els.nwalk.value||'0',10) || 0,
    tags: parseTags(els.ntags.value),
    time: els.ntime.value,
    note: els.nnote.value.trim(),
    lastPicked: 0
  };
  state.items.push(item);
  save(); clearNewForm();
  renderTagChips(); // æ–°å¢å¾ŒåŒæ­¥æ›´æ–°æ¨™ç±¤
  renderList();
};

// ===== åŒ¯å‡º CSV =====
els.exportCsv.onclick = ()=>{
  const rows = state.items.map(x=>[x.name, x.price, x.walk ?? '', (x.tags||[]).join(','), x.time||'', x.note||'']);
  const header = ['name','price','walk','tags','time','note'];
  const csv = [header, ...rows].map(r=>r.map(csvEscape).join(',')).join('\r\n');
  download('meal-list.csv', csv, 'text/csv;charset=utf-8');
  alert('å·²åŒ¯å‡º CSVï¼šmeal-list.csv');
};

function csvEscape(v){
  const s = String(v??'');
  if (/[",\n]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
  return s;
}

// ===== åŒ¯å…¥ CSVï¼ˆæ”¯æ´è¦†è“‹/è¿½åŠ ï¼‰ =====
els.importCsv.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (evt) => {
    try {
      const rows = parseSeparatedValues(evt.target.result);
      const overwrite = confirm('è¦è¦†è“‹ç¾æœ‰æ¸…å–®å—ï¼Ÿ\næŒ‰ã€Œç¢ºå®šã€= è¦†è“‹ï¼›æŒ‰ã€Œå–æ¶ˆã€= è¿½åŠ ');
      applyImportedRows(rows, overwrite);
    } catch (err) {
      alert('CSV è§£æå¤±æ•—ï¼š' + err.message);
    } finally {
      e.target.value = ''; // å…è¨±ä¸‹æ¬¡é¸åŒä¸€æª”æ¡ˆ
    }
  };
  reader.readAsText(file, 'utf-8');
});

// ===== å¾è²¼ä¸ŠåŒ¯å…¥ï¼ˆTab/é€—è™Ÿè‡ªå‹•è¾¨è­˜ï¼‰ =====
const pasteModal = document.getElementById('pasteModal');
const pasteOpen = document.getElementById('pasteOpen');
const pasteClose = document.getElementById('pasteClose');
const pasteArea  = document.getElementById('pasteArea');
const pasteImport = document.getElementById('pasteImport');

if (pasteOpen) pasteOpen.onclick = () => pasteModal.classList.add('show');
if (pasteClose) pasteClose.onclick = () => pasteModal.classList.remove('show');
if (pasteModal) pasteModal.addEventListener('click', e => { if (e.target === pasteModal) pasteModal.classList.remove('show'); });

if (pasteImport) pasteImport.onclick = () => {
  const raw = (pasteArea.value || '').trim();
  if (!raw) { alert('è«‹å…ˆè²¼ä¸Šè¡¨æ ¼å…§å®¹'); return; }
  try {
    const rows = parseSeparatedValues(raw);
    const overwrite = confirm('è¦è¦†è“‹ç¾æœ‰æ¸…å–®å—ï¼Ÿ\næŒ‰ã€Œç¢ºå®šã€= è¦†è“‹ï¼›æŒ‰ã€Œå–æ¶ˆã€= è¿½åŠ ');
    applyImportedRows(rows, overwrite);
    pasteModal.classList.remove('show');
    pasteArea.value='';
  } catch (err) {
    alert('è²¼ä¸Šè³‡æ–™è§£æå¤±æ•—ï¼š' + err.message);
  }
};

function parseSeparatedValues(text){
  const lines = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n').filter(Boolean);
  if (!lines.length) return [];
  const commaCount = (lines[0].match(/,/g) || []).length;
  const tabCount = (lines[0].match(/\t/g) || []).length;
  const sep = commaCount >= tabCount ? ',' : '\t';

  const parseLine = (line) => {
    const out = [];
    let cur = '', inQuote = false;
    for (let i=0;i<line.length;i++){
      const ch = line[i];
      if (ch === '"'){
        if (inQuote && line[i+1] === '"'){ cur += '"'; i++; }
        else inQuote = !inQuote;
      } else if (ch === sep && !inQuote){
        out.push(cur); cur = '';
      } else {
        cur += ch;
      }
    }
    out.push(cur);
    return out.map(s => s.trim());
  };

  const rows = lines.map(parseLine);
  const header = rows[0].map(x => x.toLowerCase());
  const looksHeader = header.includes('name') && header.includes('price');
  return looksHeader ? rows.slice(1) : rows;
}

function applyImportedRows(rows, overwrite=false){
  const next = overwrite ? [] : (state.items||[]).slice();
  let added = 0;
  rows.forEach(cols => {
    if (!cols.length) return;
    const [name, price, walk, tags, time, note] = cols;
    if (!name) return;
    next.push({
      id: uid(),
      name: String(name).trim(),
      price: oneOf(String(price||'$'), ['$', '$$', '$$$']),
      walk: Number(walk || 0),
      tags: String(tags||'').split(',').map(s=>s.trim()).filter(Boolean),
      time: oneOf(String(time||''), ['æ—©é¤','åˆé¤','æ™šé¤','å®µå¤œ','']),
      note: String(note||''),
      lastPicked: 0
    });
    added++;
  });
  state.items = next;
  save();
  renderTagChips();
  renderList();
  alert((overwrite?'è¦†è“‹å®Œæˆï¼Œ':'è¿½åŠ å®Œæˆï¼Œ') + 'å…±è™•ç† ' + added + ' ç­†ã€‚');
}

els.reset.onclick=()=>{
  if(confirm('ç¢ºå®šè¦æ¸…ç©ºæ¸…å–®å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')){
    state.items=[]; save();
    renderTagChips(); // æ¸…ç©ºå¾ŒåŒæ­¥æ›´æ–°
    renderList(); els.result.innerHTML='';
  }
};

els.pick1.onclick=()=>runPick(1);
els.pick3.onclick=()=>runPick(3);

els.spin.onclick=()=>{
  const candidates = filteredItems();
  if(candidates.length<2){ alert('è‡³å°‘éœ€è¦ 2 å€‹é …ç›®æ‰èƒ½ä½¿ç”¨è½‰ç›¤'); return; }
  buildWheel(candidates.slice(0,12)); // ä¸Šé™ 12 ç‰‡
  els.wheelBox.style.display='block';
  els.result.innerHTML='';
  window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
};
els.spinExit.onclick=()=>{ els.wheelBox.style.display='none'; };

els.spinGo.onclick=()=>{
  const wheel=els.wheel;
  const slices=[...wheel.querySelectorAll('.slice')];
  if(!slices.length) return;
  const spins = 5 + Math.random()*3;
  const final = Math.floor(Math.random()*slices.length);
  const anglePer = 360 / slices.length;
  const targetAngle = 360*spins + final*anglePer + anglePer/2;
  wheel.style.transition='transform 3.2s cubic-bezier(.2,.8,.2,1)';
  wheel.style.transform='rotate('+(-targetAngle)+'deg)';
  setTimeout(()=>{
    const name = slices[final].dataset.name;
    notifyPick(name);
  }, 3300);
};

function notifyPick(name){
  const it = state.items.find(x=>x.name===name);
  if(it){ it.lastPicked = Date.now(); save(); }
  showResultsModal([it || {name}]);
  els.wheelBox.style.display='none';
}

function buildWheel(items){
  const box=els.wheel;
  box.innerHTML='<div class="marker">â–¼</div>';
  box.style.transform='rotate(0deg)';
  box.style.transition='none';
  const n=items.length;
  const angle=360/n;
  for(let i=0;i<n;i++){
    const it=items[i];
    const slice=document.createElement('div');
    slice.className='slice';
    slice.dataset.name = it.name;
    const rot=i*angle;
    slice.style.transform='rotate('+rot+'deg) translate(0,0)';
    slice.style.width='50%';
    slice.style.height='50%';
    slice.style.borderTop='140px solid rgba(46,125,246,'+(0.2 + 0.6*((i%2)?1:0.5))+')';
    slice.style.borderLeft='140px solid transparent';
    slice.style.borderRight='0 solid transparent';
    slice.style.borderBottom='0 solid transparent';
    slice.style.position='absolute';
    slice.style.left='50%'; slice.style.top='50%';
    slice.style.transformOrigin='0 0';
    const label=document.createElement('div');
    label.textContent=it.name;
    label.style.position='absolute';
    label.style.left='6px'; label.style.top='-120px';
    label.style.transform='rotate(90deg)';
    label.style.whiteSpace='nowrap';
    label.style.fontSize='12px';
    slice.appendChild(label);
    box.appendChild(slice);
  }
}

function runPick(n){
  const candidates = filteredItems();
  if(!candidates.length){ showResultsModal([{name:'æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„é¸é …ï¼Œè«‹èª¿æ•´ç¯©é¸æˆ–å…ˆæ–°å¢æ¸…å–®ã€‚',note:''}], 'æç¤º'); return; }
  const scored = candidates.map(x=>{
    const hours = x.lastPicked ? (Date.now()-x.lastPicked)/36e5 : 999;
    const weight = Math.min(3, 1 + Math.log10(hours+1));
    return {it:x, w:weight};
  });
  const picks = weightedSample(scored, Math.min(n, candidates.length));
  picks.forEach(p=>{ p.lastPicked=Date.now(); });
  save();
  showResultsModal(picks);
}

function renderResultCards(items){
  return items.map(it=>{
    const t = (it.tags||[]).map(x=>'<span class="pill">'+esc(x)+'</span>').join('');
    const gmap='https://www.google.com/maps/search/?api=1&query='+encodeURIComponent(it.name);
    return `<div class="item">
      <div>
        <h3>${esc(it.name)}</h3>
        <div class="small muted">${it.price?('ğŸ’¸'+esc(it.price))+'ã€€':''}${it.walk?('ğŸš¶â€â™€ï¸'+esc(it.walk)+' åˆ†ã€€'):''}${esc(it.time||'')}</div>
        <div style="margin:6px 0">${t}</div>
        ${it.note?'<div class="small">'+esc(it.note)+'</div>':''}
      </div>
      <div class="btns">
        <a href="${gmap}" target="_blank" rel="noopener"><button class="alt">é–‹åœ°åœ–</button></a>
      </div>
    </div>`;
  }).join('');
}

function renderList(){
  const arr = filteredItems(true);
  els.list.innerHTML = arr.map(it => `
    <div class="item">
      <div>
        <h3>${esc(it.name)}</h3>
        <div class="small muted">${'ğŸ’¸'+esc(it.price)}ã€€ğŸš¶â€â™€ï¸${it.walk?esc(it.walk)+'åˆ†':''}ã€€${esc(it.time)}</div>
        <div style="margin:6px 0">${(it.tags||[]).map(x=>'<span class="pill">'+esc(x)+'</span>').join('')}</div>
        ${it.note?'<div class="small">'+esc(it.note)+'</div>':''}
      </div>
      <div class="btns">
        <button class="ghost" onclick="editItem('${it.id}')">ç·¨è¼¯</button>
        <button class="ghost" onclick="removeItem('${it.id}')">åˆªé™¤</button>
      </div>
    </div>
  `).join('');
}

function filteredItems(skipSort){
  const kw = els.q.value.trim().toLowerCase();
  const price = els.price.value;
  const time = els.time.value;
  const walk = els.walk.value ? parseInt(els.walk.value,10) : null;
  const chosenTags = [...els.tags.querySelectorAll('input:checked')].map(x=>x.value);
  let arr = state.items.filter(it=>{
    const byKw = !kw || [it.name,it.note,(it.tags||[]).join(' ')].join(' ').toLowerCase().includes(kw);
    const byPrice = !price || it.price===price;
    const byTime = !time || it.time===time;
    const byWalk = !walk || (it.walk||999) <= walk;
    const byTags = !chosenTags.length || chosenTags.every(t => (it.tags||[]).includes(t));
    return byKw && byPrice && byTime && byWalk && byTags;
  });
  if(!skipSort){
    arr.sort((a,b)=> (a.lastPicked||0)-(b.lastPicked||0) || (a.walk||999)-(b.walk||999) || (a.price||'').length-(b.price||'').length );
  }
  return arr;
}

function editItem(id){
  const it = state.items.find(x=>x.id===id);
  if(!it) return;
  const name = prompt('åº—å', it.name); if(name===null) return;
  const price = prompt('åƒ¹ä½ï¼ˆ$ / $$ / $$$ï¼‰', it.price); if(price===null) return;
  const walk = prompt('æ­¥è¡Œåˆ†é˜', it.walk); if(walk===null) return;
  const tags = prompt('æ¨™ç±¤ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰', (it.tags||[]).join(',')); if(tags===null) return;
  const time = prompt('æ™‚æ®µï¼ˆæ—©é¤/åˆé¤/æ™šé¤/å®µå¤œï¼‰', it.time); if(time===null) return;
  const note = prompt('å‚™è¨»', it.note||''); if(note===null) return;
  Object.assign(it, {name, price:oneOf(price,['$','$$','$$$']), walk:Number(walk||0), tags:parseTags(tags), time:oneOf(time,['æ—©é¤','åˆé¤','æ™šé¤','å®µå¤œ','']), note});
  save();
  renderTagChips(); // ç·¨è¼¯å¾ŒåŒæ­¥æ›´æ–°æ¨™ç±¤
  renderList();
}

function removeItem(id){
  if(!confirm('è¦åˆªé™¤é€™å€‹é …ç›®å—ï¼Ÿ')) return;
  state.items = state.items.filter(x=>x.id!==id);
  save();
  renderTagChips(); // åˆªé™¤å¾ŒåŒæ­¥æ›´æ–°æ¨™ç±¤
  renderList();
}

// Modal helpersï¼ˆæŠ½é¸çµæœï¼‰
function showResultsModal(items, title='æŠ½é¸çµæœ'){
  els.modalTitle.textContent = title;
  els.modalContent.innerHTML = renderResultCards(items);
  els.modal.classList.add('show');
}
els.modalClose.onclick = ()=> els.modal.classList.remove('show');
els.modal.addEventListener('click', (e)=>{ if(e.target===els.modal) els.modal.classList.remove('show'); });

function parseTags(s){ return s.split(',').map(x=>x.trim()).filter(Boolean); }
function oneOf(v, arr){ return arr.includes(v) ? v : arr[0]; }
function esc(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function uid(){ return Math.random().toString(36).slice(2,10); }

function load(){ try{ return JSON.parse(localStorage.getItem(KEY)) || {items:[]}; }catch{ return {items:[]}; } }
function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

function clearNewForm(){
  els.name.value=''; els.nprice.value='$'; els.nwalk.value=''; els.ntags.value=''; els.ntime.value='åˆé¤'; els.nnote.value='';
}

function weightedSample(scored, k){
  const res=[];
  const pool = scored.map(x=>({...x}));
  while(res.length<k && pool.length){
    const sum = pool.reduce((a,b)=>a+b.w,0);
    let r = Math.random()*sum;
    let idx=0;
    for(; idx<pool.length; idx++){
      r -= pool[idx].w;
      if(r<=0) break;
    }
    const item = pool.splice(Math.max(0,idx),1)[0];
    res.push(item.it);
  }
  return res;
}

// Utility: download
function download(filename, text, mime='application/octet-stream'){
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([text], {type: mime}));
  a.download = filename;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
}

renderList();
</script>
</body>
</html>
